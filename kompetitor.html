<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Laporan Kompetitor</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root{
            --dark-primary:#000000;
            --dark-text:#424242;
            --light-bg:#fcfcfc;
            --pure-white:#ffffff;
            --section-bg:#f5f5f5;
            --input-border:#bdbdbd;
            --success-color:#4CAF50;
            --error-color:#f44336;
        }

        body{
            font-family:'DM Sans',sans-serif;
            background:var(--light-bg);
            display:flex;
            justify-content:center;
            align-items:flex-start;
            min-height:100vh;
            margin:0;
            color:var(--dark-text);
        }

        .container{ background:var(--pure-white); max-width:900px; width:100%; overflow:hidden; }
        h1{ text-align:center; background:var(--dark-primary); color:#fff; margin:0; padding:20px; font-size:1.8em; font-weight:700; } 

        .form-grid{ display:grid; grid-template-columns:1fr 2fr; gap:10px 20px; align-items:center; }
        .form-grid label{ font-weight:500; text-align:right; padding-right:10px; padding-top:5px; padding-bottom:5px; line-height:1.2; }

        .data-section{ padding:15px 20px; }
        .section-title{ color:var(--dark-primary); font-size:1.4em; font-weight:700; margin-bottom:15px; }

        input[type="text"], textarea, select { 
            width:100%; 
            padding:10px; 
            border:1px solid var(--input-border); 
            border-radius:4px; 
            box-sizing:border-box; 
            font-size:0.9em; 
            transition: border-color 0.3s;
        }

        /* Highlight error */
        input.error, textarea.error, select.error {
            border-color: var(--error-color) !important;
            box-shadow: 0 0 5px rgba(244,67,54,0.3);
        }

        /* Error untuk grup produk SCI */
        #produk_sci_wrapper.error {
            border: 2px solid var(--error-color);
            border-radius: 4px;
            padding: 5px;
            box-shadow: 0 0 5px rgba(244,67,54,0.3);
        }

        .submit-container{ padding:20px 20px 30px; background:var(--section-bg); text-align:center; }
        
        /* PERBAIKAN: text-transform diubah dari uppercase menjadi capitalize */
        .btn{ padding:12px 20px; border:none; cursor:pointer; font-weight:700; text-transform:capitalize; }
        
        .btn-success{ background:var(--dark-primary); color:#fff; }
        .btn-download{ background:var(--success-color); color:#fff; }
        .btn-remove{ background:var(--input-border); color:var(--dark-text); padding:6px 12px; font-weight:500; }

        .kompetitor-group{ border:1px solid var(--input-border); padding:15px; margin-bottom:20px; border-radius:4px; background:#fff; }
        .kompetitor-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; border-bottom:1px dashed var(--input-border); padding-bottom:8px; }
        .kompetitor-header h3{ margin:0; font-size:1.05em; color:var(--dark-primary); }

        .button-container{ padding:0 20px 15px 20px; margin-top:20px; text-align:center; }

        .chip-group{ display:flex; flex-wrap:wrap; gap:8px; padding:5px 0; }
        .chip{ padding:6px 12px; border-radius:20px; cursor:pointer; font-size:0.85em; background:#e0e0e0; border:1px solid var(--input-border); display:inline-flex; align-items:center; justify-content:center; box-sizing:border-box; }
        .chip.active{ background:var(--dark-primary); color:#fff; border-color:var(--dark-primary); }
        .chip-group input[type="checkbox"]{ display:none; }

        /* Review area & wide table */
        #review-container{ padding:20px 0; display:none; background:#fff; }
        .review-scroll-wrapper{ overflow-x:auto; width:100%; padding:10px 0; }
        #review-content-capture{ background:#fff; padding:10px 20px; }

        .id-table{ border-collapse:collapse; margin-bottom:12px; }
        .id-table td{ padding:6px 8px; vertical-align:top; }

        .wide-table{ 
            border-collapse:collapse; 
            min-width:1277px; 
            width:100%; 
            table-layout:fixed; 
        }
        .wide-table th, .wide-table td{ border:1px solid #ddd; padding:8px; vertical-align:top; word-wrap:break-word; }
        .wide-table th{ background:var(--dark-primary); color:#fff; font-weight:700; text-align:center; } 
        .wide-table .right{ text-align:right; white-space:nowrap; }
        .wide-table .center{ text-align:center; white-space:nowrap; }

        .group-sep{ background:#fafafa; font-weight:700; text-align:left; }

        .grand-total-row td{ font-weight:800; background:#f3f3f3; }

        .review-actions{ text-align:center; padding:8px 20px; }
        .review-actions .btn{ margin:6px 8px; }

        .notification{ visibility:hidden; min-width:250px; margin-left:-125px; background:var(--success-color); color:#fff; text-align:center; border-radius:4px; padding:16px; position:fixed; left:50%; bottom:30px; z-index:1000; opacity:0; transition:opacity .4s, bottom .4s; }
        .notification.show{ visibility:visible; opacity:1; bottom:50px; }

        @media (max-width:768px){
            .form-grid{ grid-template-columns:1fr; }
            .form-grid label{ text-align:left; }
            #produk_sci{ display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; }
            #produk_sci .chip{ width:100%; padding:10px 8px; justify-content:center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Laporan Kompetitor</h1>

        <form id="competitor-report-form">
            <div id="data-identitas" class="data-section">
                <div class="form-grid">
                    <label for="bulan">Bulan</label>
                    <select id="bulan" name="bulan" required>
                        <option value="" disabled selected>Pilih Bulan</option>
                        <option>Januari</option><option>Februari</option><option>Maret</option>
                        <option>April</option><option>Mei</option><option>Juni</option>
                        <option>Juli</option><option>Agustus</option><option>September</option>
                        <option>Oktober</option><option>November</option><option>Desember</option>
                    </select>

                    <label for="nama_sc">Nama SC</label>
                    <select id="nama_sc" name="nama_sc" onchange="fillStoreData()" required>
                        <option value="" disabled selected>Pilih Sales Counter</option>
                    </select>

                    <label for="nama_toko">Nama Toko</label>
                    <input type="text" id="nama_toko" name="nama_toko" required readonly>

                    <label for="kategori_toko">Kategori Toko</label>
                    <select id="kategori_toko" name="kategori_toko" required>
                        <option value="" disabled selected>Pilih Kategori</option>
                        <option>Tradisional</option><option>Modern</option>
                    </select>
                </div>
            </div>

            <div id="data-kita" class="data-section">
                <h2 class="section-title">Data SCI Paint</h2>
                <div class="form-grid">
                    <label>Produk <span style="color:var(--error-color);">*</span></label>
                    <div id="produk_sci_wrapper">
                        <div class="chip-group" id="produk_sci">
                            <div class="chip" data-value="Kem-Tone">Kem-Tone <input type="checkbox" name="produk_sci[]" value="Kem-Tone"></div>
                            <div class="chip" data-value="Spectrum">Spectrum <input type="checkbox" name="produk_sci[]" value="Spectrum"></div>
                            <div class="chip" data-value="Spectrum SW08">Spectrum SW08 <input type="checkbox" name="produk_sci[]" value="Spectrum SW08"></div>
                            <div class="chip" data-value="UltraShield">UltraShield <input type="checkbox" name="produk_sci[]" value="UltraShield"></div>
                            <div class="chip" data-value="ColorTone">ColorTone <input type="checkbox" name="produk_sci[]" value="ColorTone"></div>
                            <div class="chip" data-value="Tamitex">Tamitex <input type="checkbox" name="produk_sci[]" value="Tamitex"></div>
                            <div class="chip" data-value="Vinotex">Vinotex <input type="checkbox" name="produk_sci[]" value="Vinotex"></div>
                            <div class="chip" data-value="ABC">ABC <input type="checkbox" name="produk_sci[]" value="ABC"></div>
                        </div>
                    </div>

                    <label for="omzet_toko_display">Omzet</label>
                    <input type="text" id="omzet_toko_display" name="omzet_toko_display" onkeyup="formatRupiah(this, 'omzet_toko_value')" required>
                    <input type="hidden" id="omzet_toko_value" name="omzet_toko">

                    <label for="promo_berjalan_toko">Promo yang berjalan</label>
                    <textarea id="promo_berjalan_toko" name="promo_berjalan_toko" rows="4"></textarea>

                    <label for="syarat_ketentuan_toko">Syarat & Ketentuan Promo</label>
                    <textarea id="syarat_ketentuan_toko" name="syarat_ketentuan_toko" rows="4"></textarea>
                </div>
            </div>

            <div id="data-kompetitor-main" class="data-section">
                <h2 class="section-title">Data Kompetitor</h2>
                <div id="kompetitor-container"></div>

                <div class="button-container">
                    <button type="button" class="btn btn-primary" onclick="addKompetitor()">Tambah Kompetitor</button>
                </div>
            </div>

            <div class="submit-container">
                <button type="button" class="btn btn-success" onclick="generateReview()">Review Data</button>
            </div>
        </form>

        <div id="review-container">
            <div class="review-scroll-wrapper">
                <div id="review-content-capture"></div>
            </div>

            <div class="review-actions">
                <button type="button" class="btn btn-primary" onclick="editData()">Koreksi Data</button>
                <button type="button" class="btn btn-download" onclick="sendToWhatsApp()">Kirim ke WA</button>
            </div>
        </div>

        <div id="notification" class="notification">Sedang membuka WhatsApp...</div>
    </div>

    <script>
        // DATA SC list
        const scData = [
            { nama_sc: "ACHMAD FAJAR NURSIDIQ", nama_toko: "MAKMUR MUDA", jumlah_sc: 1 },
            { nama_sc: "ADE IKHWAN FARID", nama_toko: "RUMAH WRN SEJAHTERA", jumlah_sc: 1 },
            { nama_sc: "AHMAD ZAENUDIN", nama_toko: "SINAR TERANG ABADI", jumlah_sc: 1 },
            { nama_sc: "ANINDA RAHAYU", nama_toko: "ARTESIS PLUMBING", jumlah_sc: 1 },
            { nama_sc: "ANISA SEPTIANI", nama_toko: "TUNAS BANGUNAN UBER", jumlah_sc: 1 },
            { nama_sc: "ARI ABDUL AZIS", nama_toko: "KARYA JAYA", jumlah_sc: 1 },
            { nama_sc: "ARYA YUDA", nama_toko: "BJ HOME", jumlah_sc: 1 },
            { nama_sc: "AYU OKTAVIANI", nama_toko: "BINTANG ABADI", jumlah_sc: 1 },
            { nama_sc: "CANDRA MULYADI", nama_toko: "PALEMBANG", jumlah_sc: 1 },
            { nama_sc: "DHINA TRI ANGGRAENI", nama_toko: "ANDI JAYA", jumlah_sc: 1 },
            { nama_sc: "EVI YULIA", nama_toko: "SUMBER REJEKI", jumlah_sc: 1 },
            { nama_sc: "FAHMI NUR FARIDA", nama_toko: "DEPO SS GARUT", jumlah_sc: 1 },
            { nama_sc: "FITRIA NUROHMAH", nama_toko: "TUNAS BANGUNAN TJS", jumlah_sc: 1 },
            { nama_sc: "HAFIZ AZMI", nama_toko: "KEBON KOLOT PD", jumlah_sc: 1 },
            { nama_sc: "ISNI SUSANTI", nama_toko: "BERDIKARI CIANJUR", jumlah_sc: 1 },
            { nama_sc: "IWAN SOLEH", nama_toko: "MAREMA HADE SRJ", jumlah_sc: 1 },
            { nama_sc: "JUAN", nama_toko: "MAKMUR", jumlah_sc: 1 },
            { nama_sc: "LENI NURAENI", nama_toko: "MAJU JAYA", jumlah_sc: 1 },
            { nama_sc: "LIDYA APRILIANI PRATIWI", nama_toko: "DEPO WARNA", jumlah_sc: 1 },
            { nama_sc: "LUWI MURDANI", nama_toko: "ADIL", jumlah_sc: 1 },
            { nama_sc: "MELANI RESTI SUNDARI", nama_toko: "DEPO SS PND", jumlah_sc: 1 },
            { nama_sc: "NINA SUMIATI", nama_toko: "JW CIMAHI", jumlah_sc: 1 },
            { nama_sc: "RIZKI ABDUL ROHIM", nama_toko: "PUTRA MANDIRI (GRT)", jumlah_sc: 1 },
            { nama_sc: "RUDI YUDHISTIRA", nama_toko: "DESANGKE BERSAUDARA SEJAHTERA", jumlah_sc: 1 },
            { nama_sc: "SISKA AMALIA", nama_toko: "JSM TKI", jumlah_sc: 1 },
            { nama_sc: "SUMI IGA MAWARNI", nama_toko: "KEMENANGAN JAYA", jumlah_sc: 1 },
            { nama_sc: "SYALWA TRIVIA RAMADHANI", nama_toko: "MAREMA SOHIB TKI", jumlah_sc: 1 },
            { nama_sc: "WIDANENGSIH, KEVIN, LINA", nama_toko: "DEPO BANGUNAN BDG", jumlah_sc: 3 },
            { nama_sc: "WILI KAMILUDIN", nama_toko: "JSM CIWIDEY", jumlah_sc: 1 }
        ].sort((a,b)=> a.nama_sc.localeCompare(b.nama_sc));

        let kompetitorCount = 0;

        function setupChipToggle(){
            document.addEventListener('click', function(e){
                const chip = e.target.closest('.chip');
                if(!chip) return;
                const cb = chip.querySelector('input[type="checkbox"]');
                if(!cb) return;
                cb.checked = !cb.checked;
                chip.classList.toggle('active', cb.checked);

                // Hapus error pada produk SCI jika ada yang dipilih
                const wrapper = document.getElementById('produk_sci_wrapper');
                if (wrapper && document.querySelector('#produk_sci input:checked')) {
                    wrapper.classList.remove('error');
                }
            });
        }

        function fillStoreData(){
            const sc = document.getElementById('nama_sc').value;
            const data = scData.find(x=> x.nama_sc === sc);
            document.getElementById('nama_toko').value = data ? data.nama_toko : '';
            if(data) document.getElementById('sc_count_value').value = data.jumlah_sc;
        }

        function renumberKompetitors(){
            document.querySelectorAll('.kompetitor-group').forEach((g, idx)=>{
                g.querySelector('.kompetitor-header h3').textContent = `Data Kompetitor #${idx+1}`;
            });
        }

        function addKompetitor(){
            kompetitorCount++;
            const container = document.getElementById('kompetitor-container');
            const div = document.createElement('div');
            div.className = 'kompetitor-group';
            div.innerHTML = `
                <div class="kompetitor-header">
                    <h3>Data Kompetitor #${kompetitorCount}</h3>
                    <button type="button" class="btn btn-remove" onclick="removeKompetitor(this)">Hapus</button>
                </div>
                <div class="form-grid">
                    <label>Nama Brand</label>
                    <div>
                        <select name="nama_kompetitor_select_${kompetitorCount}" onchange="toggleBrandInput(${kompetitorCount})" required>
                            <option value="" disabled selected>Pilih Brand</option>
                            <option>AM</option><option>AQUAPROOF</option><option>ARIES</option><option>ASIAN PAINT</option>
                            <option>AVIAN</option><option>AVITEX</option><option>BITAL</option><option>CANEBO</option>
                            <option>CATYLAC</option><option>DANA PAINT</option><option>DECOLITH</option><option>DULUX</option>
                            <option>INDACO</option><option>JOTUN</option><option>KANSAI</option><option>KINGKONG</option>
                            <option>METROLITE</option><option>MOWILEX</option><option>NIPPON</option><option>NODROP</option>
                            <option>PACIFIC PAINT</option><option>PARAGON</option><option>PROPAN</option><option>PURATEX</option>
                            <option>SANLEX</option><option>TOA</option><option>VINILEX</option><option>WARNA AGUNG</option>
                            <option value="LAINNYA">Lainnya (ketik sendiri)</option>
                        </select>
                        <input type="text" name="nama_kompetitor_input_${kompetitorCount}" id="nama_kompetitor_input_${kompetitorCount}" placeholder="Masukkan nama brand" style="margin-top:8px; display:none;" required>
                    </div>

                    <label></label>
                    <div class="omzet-sc-group">
                        <div class="input-wrapper">
                            <label>Omzet</label>
                            <input type="text" name="omzet_kompetitor_display_${kompetitorCount}" onkeyup="formatRupiah(this, 'omzet_kompetitor_value_${kompetitorCount}')" required>
                            <input type="hidden" name="omzet_kompetitor_value_${kompetitorCount}">
                        </div>
                        <div class="input-wrapper">
                            <label>Jumlah SC</label>
                            <select name="jumlah_sc_kompetitor_${kompetitorCount}" required>
                                <option value="" disabled selected>Pilih</option>
                                <option value="0">Tidak Ada</option>
								<option value="1">1</option><option value="2">2</option><option value="3">3</option>
                                <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                            </select>
                        </div>
                    </div>

                    <label>Promo yang berjalan</label>
                    <textarea name="promo_berjalan_kompetitor_${kompetitorCount}" rows="3"></textarea>

                    <label>Syarat & Ketentuan Promo</label>
                    <textarea name="syarat_ketentuan_kompetitor_${kompetitorCount}" rows="3"></textarea>
                </div>
            `;
            container.appendChild(div);
            renumberKompetitors();
        }

        function removeKompetitor(btn){
            btn.closest('.kompetitor-group').remove();
            renumberKompetitors();
        }

        function toggleBrandInput(id){
            const sel = document.querySelector(`select[name="nama_kompetitor_select_${id}"]`);
            const inp = document.getElementById(`nama_kompetitor_input_${id}`);
            if(!sel||!inp) return;
            if(sel.value === 'LAINNYA'){
                inp.style.display='block';
                inp.required = true;
            } else {
                inp.style.display='none';
                inp.required = false;
                inp.value = '';
            }
        }

        // Hapus class error saat input/change
        function clearErrorOnInput(){
            document.querySelectorAll('input, select, textarea').forEach(el => {
                el.addEventListener('input', function(){ this.classList.remove('error'); });
                el.addEventListener('change', function(){ this.classList.remove('error'); });
            });
        }

        function validateForm(){
            let isValid = true;
            let firstError = null;

            // Hapus semua error sebelumnya
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

            // Validasi field utama
            const mainFields = ['bulan', 'nama_sc', 'kategori_toko', 'omzet_toko_display'];
            mainFields.forEach(id => {
                const el = document.getElementById(id);
                if (!el || !el.value.trim()) {
                    el.classList.add('error');
                    if (!firstError) firstError = el;
                    isValid = false;
                }
            });

            // Validasi Produk SCI (minimal 1 dipilih)
            const produkChecked = document.querySelectorAll('#produk_sci input:checked').length;
            if (produkChecked === 0) {
                const wrapper = document.getElementById('produk_sci_wrapper');
                wrapper.classList.add('error');
                if (!firstError) firstError = wrapper;
                isValid = false;
            }

            // Validasi setiap kompetitor
            document.querySelectorAll('.kompetitor-group').forEach(group => {
                const selectBrand = group.querySelector('select[name^="nama_kompetitor_select_"]');
                const inputBrand = group.querySelector('input[name^="nama_kompetitor_input_"]');
                const omzetDisplay = group.querySelector('input[name^="omzet_kompetitor_display_"]');
                const jumlahSC = group.querySelector('select[name^="jumlah_sc_kompetitor_"]');

                let brandValue = '';
                if (selectBrand.value === 'LAINNYA') {
                    brandValue = inputBrand.value.trim();
                } else {
                    brandValue = selectBrand.value;
                }

                if (!brandValue) {
                    selectBrand.classList.add('error');
                    if (inputBrand.style.display !== 'none') inputBrand.classList.add('error');
                    if (!firstError) firstError = selectBrand;
                    isValid = false;
                }

                if (!omzetDisplay.value.trim()) {
                    omzetDisplay.classList.add('error');
                    if (!firstError) firstError = omzetDisplay;
                    isValid = false;
                }

                if (!jumlahSC.value) {
                    jumlahSC.classList.add('error');
                    if (!firstError) firstError = jumlahSC;
                    isValid = false;
                }
            });

            if (!isValid) {
                alert('Lengkapi Data');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    if (firstError.focus) firstError.focus();
                }
            }

            return isValid;
        }

        let currentData = null; // Untuk menyimpan data form saat review

        function generateReview(){
            if (!validateForm()) return;

            currentData = collectFormData();
            const cap = document.getElementById('review-content-capture');

            let totalOmzet = Number(currentData.omzet_toko || 0);
            let totalSc = Number(scData.find(x=>x.nama_sc===currentData.nama_sc)?.jumlah_sc || 0);
            currentData.kompetitor.forEach(k=>{ totalOmzet += Number(k.omzet_kompetitor||0); totalSc += Number(k.jumlah_sc_kompetitor||0); });

            const today = new Date();
            const formattedDate = today.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            const scName = escapeHtml(currentData.nama_sc); 

            let html = `<div style="text-align:center; background:var(--dark-primary); color:var(--pure-white); margin:-10px -20px 20px -20px; padding:20px; font-size:1.8em; font-weight:700; min-width:100%;">Laporan Kompetitor</div>`;

            html += `<table class="id-table">
                    <tr><td style="padding-right:18px; font-weight:700">Bulan</td><td>${escapeHtml(currentData.bulan)||'-'}</td><td style="padding-right:18px; font-weight:700">Sales Counter</td><td>${scName||'-'}</td></tr>
                    <tr><td style="font-weight:700">Store</td><td>${escapeHtml(currentData.nama_toko)||'-'}</td><td style="font-weight:700">Kategori</td><td>${escapeHtml(currentData.kategori_toko)||'-'}</td></tr>
                </table>`;

            html += `<div style="overflow-x:auto;"><table class="wide-table">
                <thead>
                    <tr>
                        <th style="min-width:315px">Brand</th> 
                        <th style="min-width:450px">Promo yang berjalan</th> 
                        <th style="min-width:550px">Syarat & Ketentuan Promo</th>
                        <th style="width:160px; text-align:center">Omzet</th>
                        <th style="width:120px; text-align:center">Jumlah SC</th>
                        <th style="width:70px; text-align:center">%</th> 
                    </tr>
                </thead>
                <tbody>`;
            
            // Data SCI Paint dipisah 1 baris
            html += `<tr class="group-sep"><td colspan="6">Data SCI Paint</td></tr>`;

            const scCount = scData.find(x=>x.nama_sc===currentData.nama_sc)?.jumlah_sc || 0;
            const sciPct = totalOmzet ? (Number(currentData.omzet_toko||0)/totalOmzet)*100 : null;
            // PERUBAHAN: Menghapus tulisan "SCI Paint" di kolom Brand, hanya menyisakan produk yang dipilih.
            html += `<tr>
                        <td>${escapeHtml(currentData.produk_sci.join(', ')||'-')}</td>
                        <td>${escapeHtml(currentData.promo_berjalan_toko)||'-'}</td>
                        <td>${escapeHtml(currentData.syarat_ketentuan_toko)||'-'}</td>
                        <td class="right">${formatToRupiah(currentData.omzet_toko)}</td>
                        <td class="center">${scCount}</td>
                        <td class="center">${sciPct===null? '-' : `${round1(sciPct)}%`}</td>
                    </tr>`;

            html += `<tr class="group-sep"><td colspan="6">Data Kompetitor</td></tr>`;

            currentData.kompetitor.forEach(k=>{
                const pct = totalOmzet ? (Number(k.omzet_kompetitor||0)/totalOmzet)*100 : null;
                html += `<tr>
                            <td>${escapeHtml(k.nama_kompetitor)||'-'}</td>
                            <td>${escapeHtml(k.promo_berjalan_kompetitor)||'-'}</td>
                            <td>${escapeHtml(k.syarat_ketentuan_kompetitor)||'-'}</td>
                            <td class="right">${formatToRupiah(k.omzet_kompetitor)}</td>
                            <td class="center">${k.jumlah_sc_kompetitor||'-'}</td>
                            <td class="center">${pct===null? '-' : `${round1(pct)}%`}</td>
                         </tr>`;
            });

            html += `</tbody>
                <tfoot>
                    <tr class="grand-total-row">
                        <td colspan="3" style="text-align:right">Grand Total</td>
                        <td class="right">${formatToRupiah(totalOmzet)}</td>
                        <td class="center">${totalSc}</td>
                        <td class="center"></td> 
                    </tr>
                </tfoot>
            </table></div>`;

            html += `<div style="margin-top:20px; text-align:right; font-size:0.85em; font-style:italic; padding-right:10px;">
                Laporan kompetitor ini dibuat oleh ${scName} pada tanggal ${formattedDate}.
            </div>`;

            cap.innerHTML = html;
            document.getElementById('competitor-report-form').style.display = 'none';
            document.getElementById('review-container').style.display = 'block';
        }

        function collectFormData(){
            const f = document.getElementById('competitor-report-form');
            const d = {};
            d.bulan = f.bulan.value;
            d.nama_sc = f.nama_sc.value;
            d.nama_toko = f.nama_toko.value;
            d.kategori_toko = f.kategori_toko.value;
            d.omzet_toko = Number(document.getElementById('omzet_toko_value').value || 0);
            d.promo_berjalan_toko = f.promo_berjalan_toko.value.trim();
            d.syarat_ketentuan_toko = f.syarat_ketentuan_toko.value.trim();
            d.produk_sci = Array.from(f.querySelectorAll('#produk_sci input:checked')).map(x=>x.value);

            d.kompetitor = [];
            document.querySelectorAll('.kompetitor-group').forEach(g=>{
                const any = g.querySelector('select[name^="nama_kompetitor_select_"]');
                if(!any) return;
                const m = any.name.match(/_(\d+)$/);
                if(!m) return;
                const i = m[1];

                const sel = g.querySelector(`select[name="nama_kompetitor_select_${i}"]`);
                const inpBrand = g.querySelector(`input[name="nama_kompetitor_input_${i}"]`);
                let nama = '';
                if(sel.value === 'LAINNYA' && inpBrand){
                    nama = inpBrand.value.trim();
                } else {
                    nama = sel.value;
                }

                const omzetVal = Number(g.querySelector(`input[name="omzet_kompetitor_value_${i}"]`)?.value || 0);
                const jumlahScVal = g.querySelector(`select[name="jumlah_sc_kompetitor_${i}"]`)?.value || '';

                d.kompetitor.push({
                    nama_kompetitor: nama,
                    omzet_kompetitor: omzetVal,
                    jumlah_sc_kompetitor: jumlahScVal,
                    promo_berjalan_kompetitor: g.querySelector(`textarea[name="promo_berjalan_kompetitor_${i}"]`)?.value.trim() || '',
                    syarat_ketentuan_kompetitor: g.querySelector(`textarea[name="syarat_ketentuan_kompetitor_${i}"]`)?.value.trim() || ''
                });
            });

            return d;
        }

        function editData(){ 
            document.getElementById('competitor-report-form').style.display = 'block'; 
            document.getElementById('review-container').style.display = 'none'; 
        }

        function formatRupiah(inp, hidNameOrId){
            let v = inp.value.replace(/[^0-9]/g,'');
            let hidEl = document.getElementById(hidNameOrId) || document.querySelector(`input[name="${hidNameOrId}"]`);
            if(hidEl) hidEl.value = v;
            inp.value = v ? `Rp ${new Intl.NumberFormat('id-ID').format(Number(v))}` : '';
        }
        function formatToRupiah(n){ return (n===0 || n) ? `Rp ${new Intl.NumberFormat('id-ID').format(Number(n))}` : '-'; }
        function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;').replace(/\n/g,'<br>'); }
        function round1(n){ return Math.round(n*10)/10; }

        document.addEventListener('DOMContentLoaded', ()=>{
            const sel = document.getElementById('nama_sc');
            scData.forEach(x=>{ const opt = document.createElement('option'); opt.value = x.nama_sc; opt.textContent = x.nama_sc; sel.appendChild(opt); });
            const hid = document.createElement('input'); hid.type='hidden'; hid.id='sc_count_value'; document.getElementById('data-identitas').appendChild(hid);
            setupChipToggle();
            clearErrorOnInput();
        });

        // ================================================
        // Kirim ke WhatsApp - HIGH QUALITY JPG dengan teks caption
        // ================================================
        async function sendToWhatsApp() {
            if (!currentData) {
                alert('Data belum di-review. Silakan review data terlebih dahulu.');
                return;
            }

            const captionText = `Laporan kompetitor bulan ${currentData.bulan} - ${currentData.nama_sc}, ${currentData.nama_toko}`;

            const captureRoot = document.getElementById('review-content-capture');
            if (!captureRoot) return alert('Tidak ada konten review untuk dikirim.');

            const scrollWrapper = document.querySelector('.review-scroll-wrapper');
            if (!scrollWrapper) return alert('Error: Wrapper scroll tidak ditemukan.');

            const originalWrapperOverflow = scrollWrapper.style.overflowX;
            const originalWrapperWidth = scrollWrapper.style.width;

            scrollWrapper.style.overflowX = 'visible';
            scrollWrapper.style.width = 'fit-content';
            scrollWrapper.style.maxWidth = 'none';

            const renderScale = 3;

            try {
                document.body.style.cursor = 'progress';

                const fullWidth = captureRoot.scrollWidth;
                const fullHeight = captureRoot.scrollHeight;

                const canvas = await html2canvas(captureRoot, {
                    scale: renderScale,
                    width: fullWidth,
                    height: fullHeight,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                });

                // Kembalikan style wrapper
                scrollWrapper.style.overflowX = originalWrapperOverflow;
                scrollWrapper.style.width = originalWrapperWidth;
                scrollWrapper.style.maxWidth = '';

                // Convert canvas ke Blob (JPEG berkualitas tinggi)
                const blob = await new Promise(resolve => {
                    canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.98);
                });

                if (!blob) {
                    alert('Gagal membuat file gambar.');
                    return;
                }

                // Buat File dari Blob
                const file = new File([blob], `laporan_kompetitor_${Date.now()}.jpg`, { type: 'image/jpeg' });

                // Cek apakah browser mendukung Web Share API (terutama mobile)
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: captionText,
                            text: captionText
                        });
                    } catch (err) {
                        if (err.name !== 'AbortError') {
                            console.warn('Share gagal:', err);
                        }
                        // Fallback jika share dibatalkan atau gagal
                        openWhatsAppWithCaption(captionText);
                    }
                } else {
                    // Fallback untuk desktop atau browser tanpa share files
                    openWhatsAppWithCaption(captionText);
                }

            } catch (err) {
                console.error("Capture atau proses gambar gagal:", err);
                alert('Gagal membuat gambar: ' + (err.message || err));
            } finally {
                document.body.style.cursor = '';

                const notif = document.getElementById('notification');
                if (notif) {
                    notif.textContent = 'Sedang membuka WhatsApp...';
                    notif.classList.add('show');
                    setTimeout(() => notif.classList.remove('show'), 3000);
                }
            }
        }

        // Fallback: Buka WhatsApp dengan teks caption (user bisa attach gambar manual jika perlu)
        function openWhatsAppWithCaption(caption) {
            const encodedCaption = encodeURIComponent(caption);
            const waUrl = `https://wa.me/?text=${encodedCaption}`;
            window.open(waUrl, '_blank');
        }
    </script>
</body>
</html>
